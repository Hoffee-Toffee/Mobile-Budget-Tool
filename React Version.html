<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Budget Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.2/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              gray: {
                900: '#1a202c',
                800: '#2d3748',
                700: '#4a5568',
              },
            },
          },
        },
      }
    </script>
    <style>
      @media print {
        .no-print,
        button,
        input:not(.print-input),
        .fa-caret-right,
        .fa-caret-down,
        .fa-trash,
        .fa-plus,
        .fa-check {
          display: none !important;
        }
        .budget-tool {
          width: 100%;
          max-width: none;
          box-shadow: none;
          border: none;
          padding: 0;
          font-family: Arial, sans-serif;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 16px;
        }
        th,
        td {
          border: 1px solid #000;
          padding: 8px;
          font-size: 12px;
          text-align: left;
        }
        th {
          background-color: #f0f0f0;
          font-weight: bold;
        }
        .calculation {
          white-space: normal;
          word-wrap: break-word;
        }
        .budget-title {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 16px;
          text-align: center;
        }
        .section-title {
          font-size: 14px;
          font-weight: bold;
          margin: 12px 0 8px;
        }
        .print-input {
          border: none;
          background: transparent;
          font-size: 12px;
          padding: 0;
          width: 100%;
        }
        .leftover {
          font-size: 12px;
          margin-top: 4px;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center p-2"
  >
    <div id="root"></div>
    <script type="text/babel">
      const { createRoot } = ReactDOM
      const { useState, useEffect, useRef } = React

      const BudgetTool = () => {
        const capitalise = (str) =>
          str
            .split(' ')
            .map((word) => word[0].toUpperCase() + word.slice(1))
            .join(' ')

        const processCalculation = (obj, asHTML = true) => {
          let vars = { ...obj }
          let msg = ''

          try {
            obj.calc.split(/({{.*?}})/g).forEach((txt) => {
              let isCalc = txt.startsWith('{{') && txt.endsWith('}}')
              if (!isCalc) return (msg += txt)

              let isCurrency = txt.startsWith('{{$') && txt.endsWith('}}')
              txt = txt.slice(isCurrency ? 3 : 2, -2)

              let [calc, out] = txt.split(' = ').reverse()
              Object.entries(vars).forEach(([key, value]) => {
                if (key === 'calc') return
                let regex = new RegExp(`\\b${key}\\b`, 'g')
                calc = calc.replace(regex, value)
              })

              let result = eval(calc)
              if (out !== undefined) vars[out] = result
              if (isCurrency) {
                result = formatCurrency(result)
                if (asHTML)
                  result = `<span class="${
                    out === 'res' || txt === 'res' ? 'font-bold ' : ''
                  }text-green-600 dark:text-green-400">${result}</span>`
              } else if (asHTML)
                result = `<span class="${
                  out === 'res' || txt === 'res' ? 'font-bold ' : ''
                }text-blue-600 dark:text-blue-400">${result}</span>`
              msg += result
            })
          } catch (e) {
            console.log(e)
            msg = '[Error: Invalid calculation]'
          }

          return { msg, res: vars.res || 0 }
        }

        // Initial data
        const initialData = {
          settings: {
            title: 'Example Budget',
            currency: 'en-US/USD',
            theme: 'light',
          },
          income: [
            {
              calc: '{{$payRate}}ph * {{hoursPerDay}}h * {{daysPerWeek}}d = {{$grossPay = payRate * hoursPerDay * daysPerWeek}}pw (gross) or ~{{$res = grossPay * netMult + netAdd}}pw (net)',
              active: true,
              payRate: 23.2,
              hoursPerDay: 7,
              daysPerWeek: 4,
              netMult: 0.777,
              netAdd: 21,
              name: 'work',
            },
            {
              name: 'benefit',
              active: false,
              res: 146.87,
              calc: '{{$res}}pw',
            },
          ],
          important: [
            {
              calc: '{{$res}}pw',
              active: true,
              res: 320,
              name: 'rent',
            },
            {
              calc: '{{$tripCost = tripCost * concessionMult}}pt * {{tripsPerDay}}t * {{daysPerWeek}}d = {{$res = tripCost * tripsPerDay * daysPerWeek}}pw (overestimate)',
              active: true,
              tripCost: 2.1,
              concessionMult: 0.5,
              tripsPerDay: 2,
              daysPerWeek: 2,
              name: 'bus costs',
            },
            {
              name: 'phone',
              calc: '~{{$monthlyCost}}pm * 12m / 52w = {{$weeklyCost = (monthlyCost * 12) / 52}}pw ~= {{$res = Math.ceil(weeklyCost / roundConst) * roundConst}}pw (rounded up just in case)',
              active: true,
              monthlyCost: 3,
              roundConst: 0.5,
            },
            {
              name: 'annual debit card fee',
              calc: '{{$yearlyCost}}py / 52w = {{$res = yearlyCost / 52}}pw (overestimate)',
              active: true,
              yearlyCost: 10,
            },
          ],
          voluntary: [
            {
              name: 'Savings',
              calc: '{{$res}}pw',
              active: true,
              res: 50,
            },
            {
              name: 'Pay Debt',
              calc: '{{$res}}pw',
              active: true,
              res: 100,
            },
          ],
        }

        const [budgetData, setBudgetData] = useState(() => {
          const saved = localStorage.getItem('budgetData')
          return saved ? JSON.parse(saved) : initialData
        })
        const [expandedItem, setExpandedItem] = useState(null)

        let { settings, ...financials } = budgetData
        if (!settings) {
          settings = initialData.settings
        }

        const [budgetTitle, setBudgetTitle] = useState(
          settings?.title || initialData.settings.title
        )
        const [isDarkMode, setIsDarkMode] = useState(settings?.theme === 'dark')
        const [currency, setCurrency] = useState(
          settings?.currency || initialData.settings.currency
        )

        useEffect(() => {
          setBudgetData((prevData) => ({
            ...prevData,
            settings: {
              ...prevData.settings,
              title: budgetTitle,
              theme: isDarkMode ? 'dark' : 'light',
              currency: currency,
            },
          }))
        }, [budgetTitle, isDarkMode, currency])

        useEffect(() => {
          document.documentElement.classList.toggle('dark', isDarkMode)
        }, [isDarkMode])

        useEffect(() => {
          localStorage.setItem('budgetData', JSON.stringify(budgetData))
        }, [budgetData])

        const toggleDarkMode = () => {
          setIsDarkMode(!isDarkMode)
          document.documentElement.classList.toggle('dark', !isDarkMode)
        }

        const currencyOptions = [
          { label: 'Dollar ($)', value: 'en-US/USD' },
          { label: 'Euro (€)', value: 'de-DE/EUR' },
          { label: 'Pound (£)', value: 'en-GB/GBP' },
          { label: 'Yen (¥)', value: 'ja-JP/JPY' },
          { label: 'Yuan (¥)', value: 'zh-CN/CNY' },
          { label: 'Rupee (₹)', value: 'en-IN/INR' },
          { label: 'Real (R$)', value: 'pt-BR/BRL' },
          { label: 'Won (₩)', value: 'ko-KR/KRW' },
          { label: 'Franc (CHF)', value: 'de-CH/CHF' },
          { label: 'Krona/Krone (kr)', value: 'sv-SE/SEK' },
          { label: 'Rubles (₽)', value: 'ru-RU/RUB' },
          { label: 'Rand (R)', value: 'en-ZA/ZAR' },
          { label: 'Zloty (zł)', value: 'pl-PL/PLN' },
          { label: 'Lira (₺)', value: 'tr-TR/TRY' },
          { label: 'Shekel (₪)', value: 'he-IL/ILS' },
          { label: 'Baht (฿)', value: 'th-TH/THB' },
          { label: 'Peso (₱)', value: 'fil-PH/PHP' },
          { label: 'Ringgit (RM)', value: 'ms-MY/MYR' },
          { label: 'Rupiah (Rp)', value: 'id-ID/IDR' },
          { label: 'Dong (₫)', value: 'vi-VN/VND' },
        ]

        const formatCurrency = (value) => {
          const [locale, currencyCode] = currency.split('/')
          return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currencyCode,
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          }).format(value)
        }

        const setFinancials = (newFinancials) => {
          setBudgetData(() => ({
            settings,
            ...newFinancials,
          }))
        }

        const handleExpand = (section, itemName) => {
          if (
            expandedItem?.section === section &&
            expandedItem?.itemName === itemName
          ) {
            setExpandedItem(null)
          } else {
            const item = financials[section].find(
              (item) => item.name === itemName
            )
            const vars = {}
            Object.entries(item).forEach(([key, value]) => {
              if (
                !['calc', 'active', 'name'].includes(key) &&
                typeof value === 'number'
              )
                vars[key] = value
            })
            setExpandedItem({
              section,
              itemName,
              data: { ...item, vars },
            })
          }
        }

        const handleNameEdit = (section, oldName, newName) => {
          if (!newName || newName === oldName) return
          const newFinancials = { ...financials }
          const sectionItems = [...newFinancials[section]]
          const itemIndex = sectionItems.findIndex(
            (item) => item.name === oldName
          )
          if (itemIndex !== -1) {
            sectionItems[itemIndex].name = newName
            newFinancials[section] = sectionItems
            setFinancials(newFinancials)
            if (
              expandedItem?.section === section &&
              expandedItem?.itemName === oldName
            ) {
              setExpandedItem({
                ...expandedItem,
                itemName: newName,
                data: { ...expandedItem.data, name: newName },
              })
            }
          }
        }

        const handleSaveEdit = (section, itemName, data) => {
          const newItemName = data.name || itemName
          const newData = {
            calc: data.calc,
            active: section === 'important' ? true : data.active,
          }
          Object.entries(data.vars).forEach(([key, value]) => {
            if (value !== '') newData[key] = parseFloat(value)
          })

          const newFinancials = { ...financials }
          const sectionItems = [...newFinancials[section]]
          const itemIndex = sectionItems.findIndex(
            (item) => item.name === itemName
          )
          if (itemIndex !== -1) {
            sectionItems[itemIndex] = { ...newData, name: newItemName }
            newFinancials[section] = sectionItems
            setFinancials(newFinancials)
          }
        }

        const handleAddItem = (section) => {
          const newItemName = `newItem${financials[section].length + 1}`
          const newItem = {
            name: newItemName,
            calc: '{{$res = 0}}pw',
            active: section !== 'important',
            vars: {},
          }
          const newFinancials = { ...financials }
          newFinancials[section] = [...newFinancials[section], newItem]
          setFinancials(newFinancials)
          setExpandedItem({
            section,
            itemName: newItemName,
            data: newItem,
          })
        }

        const handleDelete = (section, itemName) => {
          if (!window.confirm(`Delete "${capitalise(itemName)}"?`)) return
          const newFinancials = { ...financials }
          newFinancials[section] = newFinancials[section].filter(
            (item) => item.name !== itemName
          )
          setFinancials(newFinancials)
          setExpandedItem(null)
        }

        const handleExport = () => {
          try {
            const dataStr = JSON.stringify(budgetData, null, 2)
            const blob = new Blob([dataStr], { type: 'application/json' })
            const url = URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.href = url
            link.download = `${budgetTitle.replace(/\s+/g, '_')}.json`
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
            URL.revokeObjectURL(url)
            alert(`Budget exported successfully as ${link.download}!`)
          } catch (err) {
            alert(
              'Export failed: ' +
                err.message +
                '\n\nYou can copy the JSON manually:\n' +
                JSON.stringify(financials, null, 2)
            )
          }
        }

        const handleImport = (e) => {
          const file = e.target.files[0]
          if (!file) return

          const reader = new FileReader()
          reader.onload = (event) => {
            try {
              const imported = JSON.parse(event.target.result)
              setFinancials(imported)
              localStorage.setItem('budgetData', JSON.stringify(imported))
              alert('Budget imported successfully.')
            } catch (err) {
              alert('Error: Invalid JSON file.')
            }
          }
          reader.readAsText(file)
          e.target.value = null
        }

        const handleCopyToClipboard = () => {
          let summary = ''
          let total = 0

          Object.entries(financials).forEach(([section, items]) => {
            summary += `${capitalise(section)}:\n`
            let sectionTotal = 0

            items.forEach((data) => {
              let { msg, res } = processCalculation(data, false)
              sectionTotal += res * (data.active ? 1 : 0)
              summary += `  - ${capitalise(data.name)}: ${msg}${
                data.active === false ? ' (inactive)' : ''
              }\n`
            })

            summary += `  - Total: ${formatCurrency(sectionTotal)}pw\n`

            if (section !== 'income') {
              total -= sectionTotal
              summary += `Leftover: ${formatCurrency(total)}pw\n`
            } else {
              total += sectionTotal
            }
            summary += '\n'
          })

          summary = summary.slice(0, -1)

          const copyText = (text) => {
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text).then(() => {
                  alert('Summary copied to clipboard!')
                })
              }
              throw new Error('Clipboard API unavailable')
            } catch (e) {
              const textarea = document.createElement('textarea')
              textarea.value = text
              document.body.appendChild(textarea)
              textarea.select()
              try {
                document.execCommand('copy')
                alert('Summary copied to clipboard!')
              } catch (err) {
                alert('Copy failed. Please copy manually:\n\n' + text)
              } finally {
                document.body.removeChild(textarea)
              }
            }
          }

          copyText(summary)
        }

        const handleShare = async () => {
          let summary = ''
          let total = 0

          Object.entries(financials).forEach(([section, items]) => {
            summary += `${capitalise(section)}:\n`
            let sectionTotal = 0

            items.forEach((data) => {
              let { msg, res } = processCalculation(data)
              sectionTotal += res * (data.active ? 1 : 0)
              summary += `  - ${capitalise(data.name)}: ${msg}${
                data.active === false ? ' (inactive)' : ''
              }\n`
            })

            summary += `  - Total: ${formatCurrency(sectionTotal)}pw\n`

            if (section !== 'income') {
              total -= sectionTotal
              summary += `Leftover: ${formatCurrency(total)}pw\n`
            } else {
              total += sectionTotal
            }
            summary += '\n'
          })

          summary = summary.slice(0, -1)

          if (navigator.share) {
            try {
              await navigator.share({
                title: budgetTitle,
                text: summary,
              })
              alert('Budget shared successfully!')
            } catch (err) {
              alert('Sharing failed: ' + err.message)
            }
          } else {
            alert(
              'Share API not supported. You can copy the summary:\n\n' + summary
            )
          }
        }

        const handleDownloadPDF = () => {
          window.print()
        }

        const calculateSummary = () => {
          let total = 0
          const summary = {}

          Object.entries(financials).forEach(([section, items]) => {
            let sectionTotal = 0
            items.forEach((data) => {
              const { res } = processCalculation(data)
              sectionTotal += res * (data.active ? 1 : 0)
            })

            summary[section] = sectionTotal

            if (section === 'income') {
              total += sectionTotal
            } else {
              total -= sectionTotal
              summary[section + 'Leftover'] = total
            }
          })

          return summary
        }

        const VariableInput = ({
          section,
          itemName,
          oldKey,
          value,
          setData,
        }) => {
          const tempNameRef = useRef(oldKey)
          const tempValueRef = useRef(value)

          const commitNameChange = () => {
            const newKey = tempNameRef.current.trim()
            if (
              newKey &&
              newKey !== oldKey &&
              !Object.keys(expandedItem.data.vars).includes(newKey)
            ) {
              const newVars = { ...expandedItem.data.vars }
              const val = newVars[oldKey]
              delete newVars[oldKey]
              newVars[newKey] = val
              setData({ ...expandedItem.data, vars: newVars })
              handleSaveEdit(section, itemName, {
                ...expandedItem.data,
                vars: newVars,
              })
            }
          }

          const commitValueChange = () => {
            const newValue = tempValueRef.current
            const newVars = {
              ...expandedItem.data.vars,
              [oldKey]: newValue === '' ? '' : parseFloat(newValue),
            }
            setData({ ...expandedItem.data, vars: newVars })
            handleSaveEdit(section, itemName, {
              ...expandedItem.data,
              vars: newVars,
            })
          }

          return (
            <tr>
              <td className="pl-2 p-1">
                <input
                  type="text"
                  defaultValue={oldKey}
                  onInput={(e) => (tempNameRef.current = e.target.value)}
                  onBlur={commitNameChange}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault()
                      commitNameChange()
                      e.target.blur()
                    }
                  }}
                  className="p-1.5 text-xs border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 w-full"
                  placeholder="Variable name"
                />
              </td>
              <td className="p-1">
                <input
                  type="number"
                  step="any"
                  defaultValue={value}
                  onInput={(e) => (tempValueRef.current = e.target.value)}
                  onBlur={commitValueChange}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault()
                      commitValueChange()
                      e.target.blur()
                    }
                  }}
                  className="p-1.5 text-xs border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 w-full"
                  placeholder="Value"
                />
              </td>
              <td className="p-1">
                <button
                  onClick={() => {
                    const newVars = { ...expandedItem.data.vars }
                    delete newVars[oldKey]
                    setData({ ...expandedItem.data, vars: newVars })
                    handleSaveEdit(section, itemName, {
                      ...expandedItem.data,
                      vars: newVars,
                    })
                  }}
                  className="p-0.5 text-xs text-red-600 dark:text-red-400 rounded hover:text-red-700 dark:hover:text-red-300"
                >
                  <i className="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          )
        }

        const ExpandedRow = ({ section, itemName, data, setData }) => {
          const calcRef = useRef(null)
          const [tempCalc, setTempCalc] = useState(data.calc)

          useEffect(() => {
            if (calcRef.current) {
              const highlight = () => {
                let value = tempCalc
                value = value.replace(/</g, '<').replace(/>/g, '>')
                const highlighted = value
                  .replace(
                    /({{\$.*?}})/g,
                    '<span class="text-green-500 dark:text-green-300">$1</span>'
                  )
                  .replace(
                    /({{[^$].*?}})/g,
                    '<span class="text-blue-500 dark:text-blue-300">$1</span>'
                  )
                calcRef.current.innerHTML = highlighted
              }
              highlight()
            }
          }, [tempCalc])

          const handleCalcInput = (e) => {
            const selection = window.getSelection()
            const range = selection.getRangeAt(0)
            const cursorPosition = range.startOffset
            const text = e.currentTarget.textContent.replace(
              /<\/?span[^>]*>/g,
              ''
            )
            setTempCalc(text)
            // Restore cursor position
            setTimeout(() => {
              if (calcRef.current) {
                const newRange = document.createRange()
                const newSelection = window.getSelection()
                let charCount = 0
                let found = false
                const walkNodes = (node) => {
                  if (found || !node) return
                  if (node.nodeType === Node.TEXT_NODE) {
                    const len = node.textContent.length
                    if (charCount + len >= cursorPosition) {
                      newRange.setStart(node, cursorPosition - charCount)
                      newRange.setEnd(node, cursorPosition - charCount)
                      found = true
                    }
                    charCount += len
                  } else {
                    for (const child of node.childNodes) {
                      walkNodes(child)
                      if (found) break
                    }
                  }
                }
                walkNodes(calcRef.current)
                if (found) {
                  newSelection.removeAllRanges()
                  newSelection.addRange(newRange)
                }
              }
            }, 0)
          }

          const handleCalcBlur = () => {
            setData({ ...data, calc: tempCalc })
            handleSaveEdit(section, itemName, { ...data, calc: tempCalc })
          }

          const addVar = () => {
            const newKey = `var${Object.keys(data.vars).length + 1}`
            setData({ ...data, vars: { ...data.vars, [newKey]: '' } })
            handleSaveEdit(section, itemName, {
              ...data,
              vars: { ...data.vars, [newKey]: '' },
            })
          }

          const calcOutput = () => {
            const testData = { calc: tempCalc }
            Object.entries(data.vars).forEach(([k, v]) => {
              if (v !== '') testData[k] = parseFloat(v)
            })
            const { msg } = processCalculation(testData)
            return msg
          }

          return (
            <tr className="bg-gray-200 dark:bg-gray-500 !bg-opacity-20">
              <td colSpan={5} className="p-2 pl-4">
                <div className="flex flex-col gap-1">
                  <div>
                    <label className="pb-2 block text-xs font-medium dark:text-gray-200">
                      Variables
                    </label>
                    <table className="w-full border-collapse text-xs border dark:border-gray-600">
                      <thead>
                        <tr className="bg-gray-300 dark:bg-gray-600">
                          <th className="pl-2 p-1 text-left dark:text-gray-200">
                            Name
                          </th>
                          <th className="p-1 text-left dark:text-gray-200">
                            Value
                          </th>
                          <th className="p-1"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(data.vars).map(([key, value]) => (
                          <VariableInput
                            key={key}
                            section={section}
                            itemName={itemName}
                            oldKey={key}
                            value={value}
                            setData={setData}
                          />
                        ))}
                        <tr>
                          <td colSpan={2} className="p-1">
                            <button
                              onClick={addVar}
                              className="p-0.5 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
                            >
                              <i className="fas fa-plus"></i> Add Variable
                            </button>
                          </td>
                          <td className="p-1"></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div>
                    <label className="pb-2 block text-xs font-medium dark:text-gray-200">
                      Calculation
                    </label>
                    <div
                      ref={calcRef}
                      contentEditable
                      onInput={handleCalcInput}
                      onBlur={handleCalcBlur}
                      className="w-full p-2 border rounded h-12 font-mono text-xs text-black dark:text-gray-100 bg-gray-100 dark:bg-gray-600 dark:border-gray-600 overflow-y-auto resize-y"
                      style={{ whiteSpace: 'pre-wrap' }}
                      dangerouslySetInnerHTML={{
                        __html: tempCalc
                          .replace(
                            /({{\$.*?}})/g,
                            '<span class="text-green-500 dark:text-green-300">$1</span>'
                          )
                          .replace(
                            /({{[^$].*?}})/g,
                            '<span class="text-blue-500 dark:text-blue-300">$1</span>'
                          ),
                      }}
                    />
                    <p className="text-xs text-gray-600 dark:text-gray-100 bg-gray-200 dark:bg-gray-700 py-1 px-1.5 rounded mt-1 !bg-opacity-50">
                      Use <span className="text-green-500">{'{{$var}}'}</span>{' '}
                      for currency,{' '}
                      <span className="text-blue-500">{'{{var}}'}</span> for
                      calculations, set 'res' for final value.
                    </p>
                  </div>
                </div>
              </td>
            </tr>
          )
        }

        const summary = calculateSummary()

        return (
          <div className="budget-tool w-full max-w-6xl bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3">
            <div className="flex justify-between items-center mb-2">
              <input
                type="text"
                value={budgetTitle}
                onChange={(e) => setBudgetTitle(e.target.value)}
                className="print-input budget-title text-lg font-bold dark:text-gray-200 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded p-1.5 m-0 focus:ring-0"
                placeholder="Enter budget title"
              />
              <div className="flex items-center gap-2">
                <select
                  value={currency}
                  onChange={(e) => setCurrency(e.target.value)}
                  className="p-1 text-xs bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded dark:text-gray-200"
                >
                  {currencyOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
                <button
                  className="no-print p-1 text-white rounded bg-gray-800 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600"
                  aria-label="Toggle dark mode"
                  onClick={toggleDarkMode}
                >
                  {isDarkMode ? '☀️' : '🌙'}
                </button>
              </div>
            </div>
            <div className="no-print flex flex-wrap gap-1 mb-2">
              <button
                onClick={handleExport}
                className="p-1 bg-green-600 text-white rounded hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-xs"
              >
                Export
              </button>
              <label className="p-1 bg-blue-600 text-white rounded hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 cursor-pointer text-xs">
                Import
                <input
                  type="file"
                  accept=".json"
                  onChange={handleImport}
                  className="hidden"
                />
              </label>
            </div>

            {Object.entries(financials).map(([section, items]) => (
              <div key={section} className="mb-4">
                <h2 className="section-title text-md font-semibold mb-1 dark:text-gray-200">
                  {capitalise(section)}
                </h2>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse text-xs table-fixed">
                    <thead>
                      <tr className="bg-gray-200 dark:bg-gray-700">
                        <th className="p-1 w-3"></th>
                        <th
                          className={`p-1 text-left dark:text-gray-200 w-1/3 ${
                            section == 'important' && 'box-content pr-12'
                          }`}
                        >
                          Item
                        </th>
                        {section !== 'important' && (
                          <th className="p-1 text-center dark:text-gray-200 w-12">
                            Active
                          </th>
                        )}
                        <th className="p-1 text-left dark:text-gray-200 calculation">
                          Calculation
                        </th>
                        <th className="p-1 w-8"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {items.map((data) => {
                        const { name: itemName } = data
                        const { msg, res } = processCalculation(data)
                        const isExpanded =
                          expandedItem?.section === section &&
                          expandedItem?.itemName === itemName
                        return (
                          <>
                            <tr
                              key={itemName}
                              className={`border-b dark:border-gray-600 group ${
                                section !== 'important' && !data.active
                                  ? 'opacity-50'
                                  : ''
                              }`}
                            >
                              <td className="py-1">
                                <button
                                  onClick={() =>
                                    handleExpand(section, itemName)
                                  }
                                  className="px-0.5 py-2 w-3 text-xs bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500"
                                >
                                  <i
                                    className={
                                      isExpanded
                                        ? 'fas fa-caret-down'
                                        : 'fas fa-caret-right'
                                    }
                                  ></i>
                                </button>
                              </td>
                              <td className="p-1 dark:text-gray-200">
                                <div className="flex items-center gap-2">
                                  <input
                                    type="text"
                                    defaultValue={capitalise(itemName)}
                                    onBlur={(e) =>
                                      handleNameEdit(
                                        section,
                                        itemName,
                                        e.target.value.toLowerCase()
                                      )
                                    }
                                    onKeyDown={(e) => {
                                      if (e.key === 'Enter') {
                                        e.preventDefault()
                                        handleNameEdit(
                                          section,
                                          itemName,
                                          e.target.value.toLowerCase()
                                        )
                                        e.target.blur()
                                      }
                                    }}
                                    className="print-input p-1.5 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded text-xs dark:text-gray-200 w-full m-0 focus:ring-0"
                                  />
                                </div>
                              </td>
                              {section !== 'important' && (
                                <td className="place-items-center">
                                  <input
                                    type="checkbox"
                                    checked={data.active}
                                    onChange={(e) => {
                                      const newFinancials = { ...financials }
                                      const sectionItems = [
                                        ...newFinancials[section],
                                      ]
                                      const itemIndex = sectionItems.findIndex(
                                        (item) => item.name === itemName
                                      )
                                      if (itemIndex !== -1) {
                                        sectionItems[itemIndex].active =
                                          e.target.checked
                                        newFinancials[section] = sectionItems
                                        setFinancials(newFinancials)
                                        if (isExpanded) {
                                          setExpandedItem({
                                            ...expandedItem,
                                            data: {
                                              ...expandedItem.data,
                                              active: e.target.checked,
                                            },
                                          })
                                        }
                                      }
                                    }}
                                    className="hidden"
                                    id={`active-${section}-${itemName}`}
                                  />
                                  <label
                                    htmlFor={`active-${section}-${itemName}`}
                                    className="p-0.5 w-4 h-4 flex items-center justify-center rounded cursor-pointer bg-gray-400 dark:bg-gray-500"
                                  >
                                    <span className="px-0.5 w-4 h-4 block">
                                      {data.active && (
                                        <i className="fas fa-check text-xs text-white"></i>
                                      )}
                                    </span>
                                  </label>
                                </td>
                              )}
                              <td
                                className="p-1 dark:text-gray-200 truncate calculation"
                                dangerouslySetInnerHTML={{ __html: msg }}
                              />
                              <td className="p-1">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    handleDelete(section, itemName)
                                  }}
                                  className="opacity-0 group-hover:opacity-100 p-0.5 text-xs text-red-600 dark:text-red-400 rounded hover:text-red-700 dark:hover:text-red-300"
                                >
                                  <i className="fas fa-trash"></i>
                                </button>
                              </td>
                            </tr>
                            {isExpanded && (
                              <ExpandedRow
                                section={section}
                                itemName={itemName}
                                data={expandedItem.data}
                                setData={(data) =>
                                  setExpandedItem({ ...expandedItem, data })
                                }
                              />
                            )}
                          </>
                        )
                      })}
                    </tbody>
                    <tfoot>
                      <tr className="bg-gray-300 dark:bg-gray-600 !bg-opacity-50">
                        <td className="py-1">
                          <button
                            onClick={() => handleAddItem(section)}
                            className="p-0.5 w-max text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
                          >
                            <i className="fas fa-plus"></i> Add Item
                          </button>
                        </td>
                        {section == 'important' ? (
                          <td className="p-1 text-sm text-right font-bold text-gray-800 dark:text-gray-200">
                            Total:
                          </td>
                        ) : (
                          <td></td>
                        )}
                        {section !== 'important' && (
                          <td className="p-1 text-sm text-right font-bold text-gray-800 dark:text-gray-200">
                            Total:
                          </td>
                        )}
                        <td className="p-1 text-sm text-gray-800 dark:text-gray-200">
                          <strong className="text-green-600 dark:text-green-400">
                            {formatCurrency(summary[section])}
                          </strong>
                          pw
                          {section !== 'income' && (
                            <span className="leftover text-sm text-gray-600 dark:text-gray-400">
                              {' ('}
                              {section === 'voluntary'
                                ? 'Final '
                                : ''}Leftover:{' '}
                              <span
                                className={
                                  section === 'voluntary'
                                    ? summary[section + 'Leftover'] > 50
                                      ? 'text-green-600 dark:text-green-400'
                                      : summary[section + 'Leftover'] > 20
                                      ? 'text-yellow-600 dark:text-yellow-400'
                                      : summary[section + 'Leftover'] > 0
                                      ? 'text-orange-600 dark:text-orange-400'
                                      : 'text-red-600 dark:text-red-400'
                                    : ''
                                }
                              >
                                {formatCurrency(summary[section + 'Leftover'])}
                                pw
                              </span>
                              {')'}
                            </span>
                          )}
                        </td>
                        <td className="p-1"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            ))}
            <div className="no-print flex flex-wrap gap-1 mt-2">
              <button
                onClick={handleCopyToClipboard}
                className="p-1 bg-purple-600 text-white rounded hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-800 text-xs"
              >
                Copy
              </button>
              <button
                onClick={handleShare}
                className="p-1 bg-blue-600 text-white rounded hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-xs"
              >
                Share
              </button>
              <button
                onClick={handleDownloadPDF}
                className="p-1 bg-green-600 text-white rounded hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-xs"
              >
                Download
              </button>
            </div>
          </div>
        )
      }

      const root = createRoot(document.getElementById('root'))
      root.render(<BudgetTool />)
    </script>
  </body>
</html>
